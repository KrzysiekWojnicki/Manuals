
  CREATE OR REPLACE FORCE VIEW "NAGIOS"."DIRECTPAY_CORRECT_PAYMENTS_DB" ("OPERATOR", "PAYED", "NOTPAYED", "PERCENT") AS
  SELECT stats.operator,
            SUM (stats.payed) AS payed,
            SUM (stats.notpayed) AS notpayed,
            ROUND (
               (SUM (stats.payed) * 100)
               / (SUM (stats.payed) + SUM (stats.notpayed)),
               1)
               AS percent
       FROM (SELECT root.operator,
                    CASE root.key WHEN 'PAYED' THEN 1 ELSE 0 END AS payed,
                    CASE root.key WHEN 'PAYED' THEN 0 ELSE 1 END AS notpayed
               FROM (SELECT /*+ USE_INVISIBLE_INDEXES */
            o.operator,
                            s.key,
                            CASE (SELECT (TO_CHAR (
                                             SYS_EXTRACT_UTC (SYSTIMESTAMP),
                                             'HH24')
                                          - (TO_CHAR (CURRENT_TIMESTAMP,
                                                      'HH24')))
                                    FROM DUAL)
                               WHEN 2
                               THEN
                                  TO_CHAR (o.create_date + 2 / 24,
                                           'DD.MM.YYYY HH24:MI:SS')
                               ELSE
                                  TO_CHAR (o.create_date + 1 / 24,
                                           'DD.MM.YYYY HH24:MI:SS')
                            END
                               AS create_date
                       FROM    directpay.orders o
                            JOIN
                               directpay.order_status s
                            ON o.status = s.VALUE
                      WHERE operator LIKE 'POLAND_ORANGE'
                            AND s.key IN
                                   ('REJECTED', 'LOCKED', 'CANCELED', 'PAYED')
                            AND o.create_date >= SYSDATE - 3 / 24
                            AND o.direct_billing = 1
                            AND o.msisdn != '48999999999') root
              WHERE TO_DATE (root.create_date, 'DD.MM.YYYY HH24:MI:SS') >=
                       SYSDATE - .5 / 24) stats
   GROUP BY stats.operator
     HAVING ROUND (
               (SUM (stats.payed) * 100)
               / (SUM (stats.payed) + SUM (stats.notpayed)),
               1) < 40
   UNION
     SELECT stats.operator,
            SUM (stats.payed) AS payed,
            SUM (stats.notpayed) AS notpayed,
            ROUND (
               (SUM (stats.payed) * 100)
               / (SUM (stats.payed) + SUM (stats.notpayed)),
               1)
               AS percent
       FROM (SELECT root.operator,
                    CASE root.key WHEN 'PAYED' THEN 1 ELSE 0 END AS payed,
                    CASE root.key WHEN 'PAYED' THEN 0 ELSE 1 END AS notpayed
               FROM (SELECT  /*+ USE_INVISIBLE_INDEXES */
            o.operator,
                            s.key,
                            CASE (SELECT (TO_CHAR (
                                             SYS_EXTRACT_UTC (SYSTIMESTAMP),
                                             'HH24')
                                          - (TO_CHAR (CURRENT_TIMESTAMP,
                                                      'HH24')))
                                    FROM DUAL)
                               WHEN 2
                               THEN
                                  TO_CHAR (o.create_date + 2 / 24,
                                           'DD.MM.YYYY HH24:MI:SS')
                               ELSE
                                  TO_CHAR (o.create_date + 1 / 24,
                                           'DD.MM.YYYY HH24:MI:SS')
                            END
                               AS created_date
                       FROM    directpay.orders o
                            JOIN
                               directpay.order_status s
                            ON o.status = s.VALUE
                      WHERE operator LIKE 'POLAND_ERA'
                            AND s.key IN
                                   ('REJECTED', 'LOCKED', 'CANCELED', 'PAYED')
                            AND o.create_date >= SYSDATE - 3 / 24
                            AND o.direct_billing = 1
                            AND o.msisdn != '48999999999'
                            AND rwd_status NOT IN
                                   ('DB_LOCK', 'DB_LOCK_TMOBILE')) root
              WHERE TO_DATE (root.created_date, 'DD.MM.YYYY HH24:MI:SS') >=
                       SYSDATE - .5 / 24) stats
   GROUP BY stats.operator
     HAVING ROUND (
               (SUM (stats.payed) * 100)
               / (SUM (stats.payed) + SUM (stats.notpayed)),
               1) < 40
   UNION
     SELECT stats.operator,
            SUM (stats.payed) AS payed,
            SUM (stats.notpayed) AS notpayed,
            ROUND (
               (SUM (stats.payed) * 100)
               / (SUM (stats.payed) + SUM (stats.notpayed)),
               1)
               AS percent
       FROM (SELECT root.operator,
                    CASE root.key WHEN 'PAYED' THEN 1 ELSE 0 END AS payed,
                    CASE root.key WHEN 'PAYED' THEN 0 ELSE 1 END AS notpayed
               FROM (SELECT  /*+ USE_INVISIBLE_INDEXES */
            o.operator,
                            s.key,
                            CASE (SELECT (TO_CHAR (
                                             SYS_EXTRACT_UTC (SYSTIMESTAMP),
                                             'HH24')
                                          - (TO_CHAR (CURRENT_TIMESTAMP,
                                                      'HH24')))
                                    FROM DUAL)
                               WHEN 2
                               THEN
                                  TO_CHAR (o.create_date + 2 / 24,
                                           'DD.MM.YYYY HH24:MI:SS')
                               ELSE
                                  TO_CHAR (o.create_date + 1 / 24,
                                           'DD.MM.YYYY HH24:MI:SS')
                            END
                               AS created_date
                       FROM    directpay.orders o
                            JOIN
                               directpay.order_status s
                            ON o.status = s.VALUE
                      WHERE operator LIKE 'POLAND_PLUS'
                            AND s.key IN
                                   ('REJECTED', 'LOCKED', 'CANCELED', 'PAYED')
                            AND o.create_date >= SYSDATE - 3 / 24
                            AND o.direct_billing = 1
                            AND o.msisdn != '48999999999') root
              WHERE TO_DATE (root.created_date, 'DD.MM.YYYY HH24:MI:SS') >=
                       SYSDATE - .5 / 24) stats
   GROUP BY stats.operator
     HAVING ROUND (
               (SUM (stats.payed) * 100)
               / (SUM (stats.payed) + SUM (stats.notpayed)),
               1) < 40
   UNION
     SELECT stats.operator,
            SUM (stats.payed) AS payed,
            SUM (stats.notpayed) AS notpayed,
            ROUND (
               (SUM (stats.payed) * 100)
               / (SUM (stats.payed) + SUM (stats.notpayed)),
               1)
               AS percent
       FROM (SELECT root.operator,
                    CASE root.key WHEN 'PAYED' THEN 1 ELSE 0 END AS payed,
                    CASE root.key WHEN 'PAYED' THEN 0 ELSE 1 END AS notpayed
               FROM (SELECT  /*+ USE_INVISIBLE_INDEXES */
            o.operator,
                            s.key,
                            CASE (SELECT (TO_CHAR (
                                             SYS_EXTRACT_UTC (SYSTIMESTAMP),
                                             'HH24')
                                          - (TO_CHAR (CURRENT_TIMESTAMP,
                                                      'HH24')))
                                    FROM DUAL)
                               WHEN 2
                               THEN
                                  TO_CHAR (o.create_date + 2 / 24,
                                           'DD.MM.YYYY HH24:MI:SS')
                               ELSE
                                  TO_CHAR (o.create_date + 1 / 24,
                                           'DD.MM.YYYY HH24:MI:SS')
                            END
                               AS created_date
                       FROM    DIRECTPAY.orders o
                            JOIN
                               directpay.order_status s
                            ON o.status = s.VALUE
                      WHERE operator LIKE 'POLAND_P4'
                            AND s.key IN
                                   ('REJECTED', 'LOCKED', 'CANCELED', 'PAYED')
                            AND o.create_date >= SYSDATE - 3 / 24
                            AND o.direct_billing = 1
                            AND o.msisdn != '48999999999') root
              WHERE TO_DATE (root.created_date, 'DD.MM.YYYY HH24:MI:SS') >=
                       SYSDATE - .5 / 24) stats
   GROUP BY stats.operator
     HAVING ROUND (
               (SUM (stats.payed) * 100)
               / (SUM (stats.payed) + SUM (stats.notpayed)),
               1) < 35;
